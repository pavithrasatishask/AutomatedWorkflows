{
  "name": "DevSecOps Automation",
  "nodes": [
    {
      "parameters": {
        "content": "## DevSecOps Automation Workflow\nPurpose: Automatically syncs GitHub security alerts to Azure DevOps PBIs for tracking and remediation.\n\n**How it works:**\n\nScans configured GitHub repositories for critical/high severity security alerts (Code Scanning, Dependabot, Secret Scanning)\nGroups alerts by vulnerability type\nUses AI to intelligently create new PBIs or update existing ones\nPrevents duplicate alert URLs - only adds new occurrences to existing PBIs\nLinks all PBIs to parent security work item with proper categorization\n\n**Key Features:**\n\nAutomatic deduplication of vulnerabilities across repositories\nSmart URL tracking - won't add the same alert twice\nDetailed PBI descriptions with vulnerability details and clickable alert links\nMaintains history of when new alerts are detected\nExecution: Run manually or schedule as needed to keep Azure DevOps in sync with GitHub security posture.",
        "height": 1024,
        "width": 3552,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        47072,
        32400
      ],
      "id": "c103bdaa-5327-4f7b-a8c3-fc34e00f8e94",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "517d24e8-5acd-41e5-8c3a-e4d3adb2f4b1",
      "name": "Loop Over Items2",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        49424,
        32944
      ],
      "notes": "Processes 1 vulnerability at a time (change to 5 for batches)"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "all_results",
        "options": {}
      },
      "id": "a6de8cbd-ae59-4f23-9d50-028bd7f67c5c",
      "name": "Aggregate Results2",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        49664,
        33136
      ],
      "notes": "Collects all loop results automatically"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ JSON.stringify($json.vulnerability) }}",
        "options": {
          "systemMessage": "You are a DevSecOps automation assistant. Your job is to process a SINGLE GitHub security vulnerability and manage Azure DevOps Product Backlog Items (PBIs).\n\n## YOUR WORKFLOW:\n\n1. **Understand the Input Data**\n   - You will receive ONE vulnerability object with:\n     * type: Alert type (Dependabot, Secret Scanning, or Code Scanning)\n     * vulnerability_title: The vulnerability identifier\n     * vulnerability_details: Description of the vulnerability\n     * alert_urls: Array of GitHub alert URLs for this vulnerability\n     * severity: Severity level\n     * count: Number of alerts for this vulnerability\n\n2. **Process This Single Vulnerability:**\n   \n   **Step A: Search for Existing PBI**\n   - Call \"Search PBI by Vulnerability Title\" tool\n   - Pass the vulnerability_title from the input\n   - Check if workItems array is empty or has items\n   \n   **Step B: Create OR Update Based on Search Results**\n   \n   - IF workItems array is EMPTY (no existing PBI):\n     * Call \"Create New Security PBI\" tool with:\n       - vulnerability_title\n       - vulnerability_details\n       - alert_urls formatted as HTML list: '<ul><li><a href=\"URL1\">Alert #1</a></li>...</ul>'\n     * Return result with: { action: \"created\", pbi_id: <id>, title: <title> }\n   \n   - IF workItems array HAS ITEMS (existing PBI found):\n     * Get pbi_id from first item in workItems array\n     * Call \"Get PBI Details\" tool with pbi_id to retrieve current description\n     * Extract existing alert URLs from the description HTML\n     * Compare input alert_urls against existing URLs\n     * Identify NEW URLs (not already in description)\n     * IF there are new URLs:\n       - Format new URLs as HTML list\n       - Call \"Update Security PBI\" tool with:\n         * pbi_id\n         * existing_description (from Get PBI Details)\n         * new_alert_urls (formatted HTML list of NEW URLs only)\n       - Return result with: { action: \"updated\", pbi_id: <id>, title: <title>, new_urls_added: <count> }\n     * IF no new URLs:\n       - Return result with: { action: \"skipped\", pbi_id: <id>, title: <title>, reason: \"All URLs already exist\" }\n\n3. **Return Result**\n   You MUST return a JSON object with these fields:\n   - action: \"created\" | \"updated\" | \"skipped\"\n   - pbi_id: The Azure DevOps PBI ID number\n   - title: The vulnerability title\n   - new_urls_added: (for updates) Number of new URLs added\n   - reason: (for skipped) Why it was skipped\n\n## IMPORTANT RULES:\n- Process ONLY ONE vulnerability per execution\n- ALWAYS call Search PBI first before any other action\n- DO NOT call Get PBI Details if search returns empty workItems - go straight to Create\n- ALWAYS call Get PBI Details before Update to get current description\n- Compare URLs carefully - only add truly NEW URLs not already in description\n- Format all alert URLs as proper HTML unordered lists with anchor tags\n- Use exact tool names: \"Search PBI by Vulnerability Title\", \"Get PBI Details\", \"Create New Security PBI\", \"Update Security PBI\"\n- Return a clear JSON response with action taken",
          "returnIntermediateSteps": true
        }
      },
      "id": "4b039956-c156-4e8a-8ebf-9233edf7f582",
      "name": "AI Agent3",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        49792,
        32496
      ],
      "notes": "Processes ONE vulnerability at a time"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        49648,
        32912
      ],
      "id": "c075866f-736a-473e-bbe5-0cdac27880dc",
      "name": "OpenAI Chat Model3",
      "credentials": {
        "openAiApi": {
          "id": "L6ctMkvByaGpC7gC",
          "name": "OpenAi account 2"
        }
      },
      "notes": "GPT-4o language model"
    },
    {
      "parameters": {
        "toolDescription": "Creates a new Product Backlog Item for a security vulnerability in Azure DevOps. Input: vulnerability_title (string), vulnerability_details (string), alert_urls (string - HTML formatted list). Returns: Created PBI object with id and other fields.",
        "method": "POST",
        "url": "https://fe-tfs.visualstudio.com/Precision%20Plus/_apis/wit/workitems/$Product Backlog Item?api-version=7.0",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json-patch+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "=[\n  { \"op\": \"add\", \"path\": \"/fields/System.Title\", \"value\": {{ $fromAI(\"vulnerability_title\").toJsonString() }} },\n  { \"op\": \"add\", \"path\": \"/fields/System.Description\", \"value\": {{ (\"<p><strong>Purpose:</strong> This PBI tracks security vulnerabilities identified in our repositories that require remediation to maintain code security and compliance.</p><p><strong>Vulnerability Details:</strong></p><p>\" + $fromAI(\"vulnerability_details\") + \"</p><p><strong>Affected Alert URLs:</strong></p>\" + $fromAI(\"alert_urls\")).toJsonString() }} },\n  { \"op\": \"add\", \"path\": \"/fields/Microsoft.VSTS.Common.AcceptanceCriteria\", \"value\": {{ (\"<p><strong>Purpose:</strong> This PBI tracks security vulnerabilities identified in our repositories that require remediation to maintain code security and compliance.</p><p><strong>Vulnerability Details:</strong></p><p>\" + $fromAI(\"vulnerability_details\") + \"</p><p><strong>Affected Alert URLs:</strong></p>\" + $fromAI(\"alert_urls\")).toJsonString() }} },\n  { \"op\": \"add\", \"path\": \"/fields/Custom.ProductCategory\", \"value\": \"Documents\" },\n  { \"op\": \"add\", \"path\": \"/fields/Custom.EffortTypePrecisionPlus\", \"value\": \"Security Enhancements\" },\n  { \"op\": \"add\", \"path\": \"/relations/-\", \"value\": { \"rel\": \"System.LinkTypes.Hierarchy-Reverse\", \"url\": \"https://fe-tfs.visualstudio.com/Precision%20Plus/_apis/wit/workitems/528765\" } }\n]",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        49776,
        32912
      ],
      "id": "51e03d6a-3e8f-4364-b7d1-acc64f26bb01",
      "name": "create_new_pbi3",
      "credentials": {
        "httpBasicAuth": {
          "id": "n0WqaasbuBjHcrAl",
          "name": "AzureDevOps_PATToken"
        }
      },
      "notes": "Tool: Creates new PBI"
    },
    {
      "parameters": {
        "toolDescription": "Searches for existing Azure DevOps PBIs matching a vulnerability title. Input: vulnerability_title (string). Returns: Array of matching work items with id and title, or empty array if none found.",
        "method": "POST",
        "url": "https://fe-tfs.visualstudio.com/Precision%20Plus/_apis/wit/wiql?api-version=7.0",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  query: \"Select [System.Id], [System.Title] From WorkItems Where [System.WorkItemType] = 'Product Backlog Item' And [System.Parent] = 528765 AND [System.Title] = '\" + $fromAI('vulnerability_title').replace(/'/g, \"''\") + \"' AND [System.TeamProject] = 'Precision Plus'\"\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        49904,
        32912
      ],
      "id": "111f6541-61f9-4da7-8115-db597a74d849",
      "name": "search_for_existing_pbi3",
      "credentials": {
        "httpBasicAuth": {
          "id": "n0WqaasbuBjHcrAl",
          "name": "AzureDevOps_PATToken"
        }
      },
      "notes": "Tool: Searches for existing PBI"
    },
    {
      "parameters": {
        "toolDescription": "Updates an existing Azure DevOps PBI by appending new alert URLs to the description. Input: pbi_id (number from search results), new_alert_urls (string - HTML formatted list of NEW alert URLs only), existing_description (string - current description content from Get PBI Details tool). Returns: Updated PBI object.",
        "method": "PATCH",
        "url": "=https://fe-tfs.visualstudio.com/Precision%20Plus/_apis/wit/workitems/{{ $fromAI('pbi_id') }}?api-version=7.0",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json-patch+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "=[\n  {\n    \"op\": \"replace\",\n    \"path\": \"/fields/System.Description\",\n    \"value\": {{ ($fromAI(\"existing_description\") + \"<p><strong>New Alerts Added:</strong></p>\" + $fromAI(\"new_alert_urls\")).toJsonString() }}\n  },\n  {\n    \"op\": \"add\",\n    \"path\": \"/fields/System.History\",\n    \"value\": {{ (\"New vulnerability occurrences detected and added to description: \" + $fromAI(\"new_alert_urls\")).toJsonString() }}\n  }\n]",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        50032,
        32912
      ],
      "id": "f775c68b-ea2d-4237-9ade-25fd1a9dff2c",
      "name": "update_existing_pbi3",
      "credentials": {
        "httpBasicAuth": {
          "id": "n0WqaasbuBjHcrAl",
          "name": "AzureDevOps_PATToken"
        }
      },
      "notes": "Tool: Updates existing PBI"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "repos",
              "value": "={{ [\"Precision-Plus-Infra_PrecisionPlus_Tools\",\"Precision-Plus-KiiHub\",\"Precision-Plus-CommonServices\",\"Precision-Plus-yoursri.content\",\"Precision-Plus-CoreDocumentsAPI.Internal\",\"Precision-Plus-PlusDocuments\",\"Precision-Plus-PlusDocumentsApps\",\"Precision-Plus-CoreDocumentsAPI\",\"Precision-Plus-AMS-FSW-Module\",\"Precision-Plus-CalculationEngine\",\"Precision-Plus-CalculationEngineeTool\",\"Precision-Plus-FactsheetPlatform\"] }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Repo List3",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        47872,
        32960
      ],
      "id": "461de65b-124f-46ed-9350-7bfd24accd5c",
      "notes": "List of repositories to scan"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "name": "Combine All Alerts3",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        48784,
        32960
      ],
      "id": "25c5c564-8e0e-4b96-9034-0e8812f5a12c",
      "notes": "Combines all alerts from all sources"
    },
    {
      "parameters": {
        "url": "=https://api.github.com/repos/fefundinfo-internal/{{$json.repos}}/code-scanning/alerts?state=open&severity=critical&severity=high",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "name": "Get Code Scanning3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        48320,
        32816
      ],
      "id": "6a12686e-3231-4e15-ba06-ee08f7680435",
      "alwaysOutputData": true,
      "credentials": {
        "httpBasicAuth": {
          "id": "sJKVQMBeu5eNfJc4",
          "name": "GitHub PAT Token"
        }
      },
      "notes": "Fetches Code Scanning alerts"
    },
    {
      "parameters": {
        "url": "=https://api.github.com/repos/fefundinfo-internal/{{$json.repos}}/dependabot/alerts?state=open&severity=critical,high",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "name": "Get Dependabot3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        48320,
        33008
      ],
      "id": "03f4adcf-9abb-4d82-b305-f1b2d404a7b7",
      "alwaysOutputData": true,
      "credentials": {
        "httpBasicAuth": {
          "id": "sJKVQMBeu5eNfJc4",
          "name": "GitHub PAT Token"
        }
      },
      "notes": "Fetches Dependabot alerts"
    },
    {
      "parameters": {
        "url": "=https://api.github.com/repos/fefundinfo-internal/{{$json.repos}}/secret-scanning/alerts?state=open&severity=critical&severity=high",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "name": "Get Secret Scanning3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        48320,
        33200
      ],
      "id": "8e123217-dd59-4568-81e0-c971f50d445a",
      "alwaysOutputData": true,
      "credentials": {
        "httpBasicAuth": {
          "id": "sJKVQMBeu5eNfJc4",
          "name": "GitHub PAT Token"
        }
      },
      "notes": "Fetches Secret Scanning alerts"
    },
    {
      "parameters": {
        "fieldToSplitOut": "repos",
        "options": {}
      },
      "name": "Split Repos3",
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 1,
      "position": [
        48096,
        32960
      ],
      "id": "c6da44e5-3a0c-4cb9-baa8-b4e553a00b96"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "all_alerts",
        "options": {}
      },
      "name": "Aggregate All Alerts3",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        48976,
        32944
      ],
      "id": "9ae3772e-785e-4790-876e-1b1d1ef5962f",
      "notes": "Bundles all alerts into single item"
    },
    {
      "parameters": {
        "toolDescription": "Retrieves full details of an existing Azure DevOps PBI including description field. Input: pbi_id (number). Returns: Complete PBI object with all fields including System.Description.",
        "url": "=https://fe-tfs.visualstudio.com/Precision%20Plus/_apis/wit/workitems/{{ $fromAI('pbi_id') }}?api-version=7.0",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "options": {}
      },
      "id": "77b5ece5-0c08-434e-a901-5a1d53ea79b6",
      "name": "get_pbi_details3",
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        50160,
        32912
      ],
      "credentials": {
        "httpBasicAuth": {
          "id": "n0WqaasbuBjHcrAl",
          "name": "AzureDevOps_PATToken"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nif (!items || items.length === 0) {\n  return [];\n}\n\nconst allAlerts = items[0].json.all_alerts || [];\n\n// Group by scan type + title\nconst grouped = {};\n\nfor (const alert of allAlerts) {\n  const key = `${alert.scan_type}:${alert.title}`;\n  \n  if (!grouped[key]) {\n    grouped[key] = {\n      type: alert.scan_type,\n      vulnerability_title: alert.title,\n      vulnerability_details: alert.description,\n      severity: alert.severity,\n      repository: alert.repository,\n      alert_urls: [],\n      count: 0\n    };\n  }\n  \n  if (alert.html_url && !grouped[key].alert_urls.includes(alert.html_url)) {\n    grouped[key].alert_urls.push(alert.html_url);\n    grouped[key].count++;\n  }\n}\n\nconst compressed = Object.values(grouped);\n\nconsole.log(`Compressed ${allAlerts.length} â†’ ${compressed.length} vulnerabilities`);\n\nreturn compressed.map(alert => ({\n  json: {\n    vulnerability: alert,\n    repo: alert.repository,\n    type: alert.type\n  }\n}));"
      },
      "id": "313a8f99-a22e-49d1-b82a-1bf4c07151d4",
      "name": "Compress Alert Data3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        49200,
        32944
      ],
      "notes": "Prepares data for loop processing"
    },
    {
      "parameters": {
        "jsCode": "const reportData = $input.first().json;\nconst detailedData = reportData.detailedData || {};\n\nfunction getStatusIndicator(alertCount) {\n  if (alertCount === 0) return \"âœ…\";\n  if (alertCount <= 5) return \"âš ï¸\";\n  return \"ðŸ”´\";\n}\n\nconst repositorySections = [];\n\nfor (const [repoName, categories] of Object.entries(detailedData)) {\n  let totalAlerts = 0;\n  let totalVulns = 0;\n  let totalPBIs = 0;\n  \n  const categoryContainers = [];\n  \n  for (const [category, data] of Object.entries(categories)) {\n    totalAlerts += data.totalAlerts || 0;\n    totalVulns += data.uniqueVulnerabilities || 0;\n    totalPBIs += data.pbisCreated || 0;\n    \n    const categoryBlock = {\n      type: \"Container\",\n      style: \"emphasis\",\n      spacing: \"Small\",\n      items: [\n        {\n          type: \"ColumnSet\",\n          columns: [\n            {\n              type: \"Column\",\n              width: \"stretch\",\n              items: [{ type: \"TextBlock\", text: `**${category}**`, weight: \"Bolder\", size: \"Medium\" }]\n            },\n            {\n              type: \"Column\",\n              width: \"auto\",\n              items: [{ type: \"TextBlock\", text: getStatusIndicator(data.totalAlerts), size: \"Medium\" }]\n            }\n          ]\n        },\n        {\n          type: \"FactSet\",\n          spacing: \"Small\",\n          facts: [\n            { title: \"ðŸ”” Alerts\", value: `${data.totalAlerts || 0}` },\n            { title: \"ðŸ›¡ï¸ Unique Vulnerabilities\", value: `${data.uniqueVulnerabilities || 0}` },\n            { title: \"ðŸ“‹ PBIs Created\", value: `${data.pbisCreated || 0}` }\n          ]\n        }\n      ]\n    };\n    \n    // Add PBI list with clickable links\n    if (data.pbiList && data.pbiList.length > 0) {\n      categoryBlock.items.push({\n        type: \"TextBlock\",\n        text: \"**Product Backlog Items:**\",\n        weight: \"Bolder\",\n        spacing: \"Small\",\n        size: \"Small\"\n      });\n      \n      // Create clickable buttons (max 5)\n      const pbiActions = data.pbiList.slice(0, 5).map(pbi => ({\n        type: \"Action.OpenUrl\",\n        title: `PBI #${pbi.id}`,\n        url: pbi.url,\n        style: \"positive\"\n      }));\n      \n      categoryBlock.items.push({\n        type: \"ActionSet\",\n        actions: pbiActions\n      });\n      \n      // Show remaining as text if more than 5\n      if (data.pbiList.length > 5) {\n        const remaining = data.pbiList.slice(5).map(pbi => `[PBI #${pbi.id}](${pbi.url})`).join(\", \");\n        categoryBlock.items.push({\n          type: \"TextBlock\",\n          text: remaining,\n          wrap: true,\n          size: \"Small\"\n        });\n      }\n    }\n    \n    categoryContainers.push(categoryBlock);\n  }\n  \n  const repoSection = {\n    type: \"Container\",\n    separator: true,\n    spacing: \"Medium\",\n    items: [\n      {\n        type: \"ColumnSet\",\n        columns: [\n          {\n            type: \"Column\",\n            width: \"stretch\",\n            items: [{ type: \"TextBlock\", text: `ðŸ“¦ ${repoName}`, size: \"Large\", weight: \"Bolder\", color: \"Accent\" }]\n          },\n          {\n            type: \"Column\",\n            width: \"auto\",\n            items: [{ type: \"TextBlock\", text: `${totalAlerts} alerts â€¢ ${totalVulns} vulns â€¢ ${totalPBIs} PBIs`, size: \"Small\", horizontalAlignment: \"Right\" }]\n          }\n        ]\n      },\n      { type: \"Container\", spacing: \"Small\", items: categoryContainers }\n    ]\n  };\n  \n  repositorySections.push(repoSection);\n}\n\nlet grandTotalAlerts = 0;\nlet grandTotalVulns = 0;\nlet grandTotalPBIs = 0;\n\nfor (const categories of Object.values(detailedData)) {\n  for (const data of Object.values(categories)) {\n    grandTotalAlerts += data.totalAlerts || 0;\n    grandTotalVulns += data.uniqueVulnerabilities || 0;\n    grandTotalPBIs += data.pbisCreated || 0;\n  }\n}\n\nconst adaptiveCard = {\n  type: \"message\",\n  attachments: [{\n    contentType: \"application/vnd.microsoft.card.adaptive\",\n    content: {\n      type: \"AdaptiveCard\",\n      version: \"1.5\",\n      \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n      body: [\n        {\n          type: \"Container\",\n          style: \"emphasis\",\n          items: [\n            { type: \"TextBlock\", text: \"ðŸ”’ Security Alerts Report\", size: \"ExtraLarge\", weight: \"Bolder\", color: \"Accent\" },\n            { type: \"TextBlock\", text: `Generated on ${new Date().toLocaleString()}`, size: \"Small\", spacing: \"None\", isSubtle: true }\n          ],\n          bleed: true\n        },\n        {\n          type: \"Container\",\n          spacing: \"Medium\",\n          items: [\n            { type: \"TextBlock\", text: \"ðŸ“Š Overall Summary\", weight: \"Bolder\", size: \"Medium\" },\n            {\n              type: \"ColumnSet\",\n              spacing: \"Small\",\n              columns: [\n                {\n                  type: \"Column\",\n                  width: \"stretch\",\n                  items: [{\n                    type: \"Container\",\n                    style: \"emphasis\",\n                    items: [\n                      { type: \"TextBlock\", text: `${grandTotalAlerts}`, size: \"ExtraLarge\", weight: \"Bolder\", horizontalAlignment: \"Center\" },\n                      { type: \"TextBlock\", text: \"Total Alerts\", size: \"Small\", horizontalAlignment: \"Center\", spacing: \"None\", isSubtle: true }\n                    ]\n                  }]\n                },\n                {\n                  type: \"Column\",\n                  width: \"stretch\",\n                  items: [{\n                    type: \"Container\",\n                    style: \"emphasis\",\n                    items: [\n                      { type: \"TextBlock\", text: `${grandTotalVulns}`, size: \"ExtraLarge\", weight: \"Bolder\", horizontalAlignment: \"Center\" },\n                      { type: \"TextBlock\", text: \"Vulnerabilities\", size: \"Small\", horizontalAlignment: \"Center\", spacing: \"None\", isSubtle: true }\n                    ]\n                  }]\n                },\n                {\n                  type: \"Column\",\n                  width: \"stretch\",\n                  items: [{\n                    type: \"Container\",\n                    style: \"emphasis\",\n                    items: [\n                      { type: \"TextBlock\", text: `${grandTotalPBIs}`, size: \"ExtraLarge\", weight: \"Bolder\", horizontalAlignment: \"Center\" },\n                      { type: \"TextBlock\", text: \"PBIs Created\", size: \"Small\", horizontalAlignment: \"Center\", spacing: \"None\", isSubtle: true }\n                    ]\n                  }]\n                }\n              ]\n            }\n          ]\n        },\n        { type: \"TextBlock\", text: \"ðŸ“ Repository Details\", weight: \"Bolder\", size: \"Medium\", spacing: \"Large\" },\n        ...repositorySections\n      ]\n    }\n  }]\n};\n\nreturn { json: adaptiveCard };"
      },
      "id": "dfd19512-f4f7-46cf-ac4c-59cf20159c17",
      "name": "Format Adaptive Card3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        50048,
        33136
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://default82f41f1bd00f4f7ba740e0fd8515f2.72.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/30d7a20a7d29431cb12fbf71d9e031f8/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=7CR-QhpWtPUCkko_LFUl4VUFpmZXW3R7BEleQ6R9-AQ",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "id": "aadac0ef-a27f-4fc3-a1a7-e8c52a3a2394",
      "name": "Post to Teams3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        50256,
        33136
      ],
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst allResults = input.all_results || [];\n\nconsole.log('=== Generate Report ===');\nconsole.log('Total results:', allResults.length);\n\nconst detailedData = {};\n\nfor (const result of allResults) {\n  const vuln = result.vulnerability || result;\n  const repo = vuln.repository || 'Unknown';\n  const scanType = vuln.type || 'Unknown';\n  \n  if (!detailedData[repo]) {\n    detailedData[repo] = {};\n  }\n  \n  if (!detailedData[repo][scanType]) {\n    detailedData[repo][scanType] = {\n      totalAlerts: 0,\n      uniqueVulnerabilities: 0,\n      pbisCreated: 0,\n      pbiList: []\n    };\n  }\n  \n  detailedData[repo][scanType].totalAlerts += vuln.count || 1;\n  detailedData[repo][scanType].uniqueVulnerabilities += 1;\n  \n  if (result.action === 'created' && result.pbi_id) {\n    detailedData[repo][scanType].pbisCreated += 1;\n    detailedData[repo][scanType].pbiList.push({\n      id: result.pbi_id,\n      title: vuln.vulnerability_title,\n      url: `https://fe-tfs.visualstudio.com/Precision%20Plus/_workitems/edit/${result.pbi_id}`\n    });\n  } else if (result.action === 'updated' && result.pbi_id) {\n    const exists = detailedData[repo][scanType].pbiList.find(p => p.id === result.pbi_id);\n    if (!exists) {\n      detailedData[repo][scanType].pbiList.push({\n        id: result.pbi_id,\n        title: vuln.vulnerability_title,\n        url: `https://fe-tfs.visualstudio.com/Precision%20Plus/_workitems/edit/${result.pbi_id}`\n      });\n    }\n  }\n}\n\nconst summary = {\n  total_processed: allResults.length,\n  created: allResults.filter(r => r.action === 'created').length,\n  updated: allResults.filter(r => r.action === 'updated').length,\n  skipped: allResults.filter(r => r.action === 'skipped').length\n};\n\nreturn [{\n  json: {\n    detailedData,\n    summary,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "671ac1c0-6de8-48e5-9037-8057620499f6",
      "name": "Generate Report2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        49856,
        33136
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// Check if we have any items\nif (!items || items.length === 0) {\n  console.log('Filter Secret Scanning: No items to process');\n  return [];\n}\n\n// Filter out empty/invalid items\nconst validItems = items.filter(item => {\n  const alert = item.json;\n  return alert && \n         alert.secret_type_display_name && \n         alert.html_url &&\n         !alert.message;\n});\n\nif (validItems.length === 0) {\n  console.log('Filter Secret Scanning: No valid secret scanning alerts found');\n  return [];\n}\n\nconsole.log(`Filter Secret Scanning: Processing ${validItems.length} alerts`);\n\nreturn validItems.map(item => {\n  const alert = item.json;\n  \n  return {\n    json: {\n      scan_type: 'Secret Scanning',\n      title: alert.secret_type_display_name,\n      description: `**Secret Type:** ${alert.secret_type_display_name}\n**Secret:** ${alert.secret || 'Redacted'}\n**First Location:** ${alert.locations?.[0]?.details?.path || 'Unknown'}\n**Alert URL:** ${alert.html_url}`,\n      html_url: alert.html_url,\n      severity: 'high',\n      state: alert.state || 'open',\n      repository: extractRepo(alert.html_url)\n    }\n  };\n});\n\nfunction extractRepo(url) {\n  if (!url) return 'Unknown';\n  const match = url.match(/github\\.com\\/[^\\/]+\\/([^\\/]+)/);\n  return match ? match[1] : 'Unknown';\n}"
      },
      "id": "d697cf3e-6330-4bfa-90d0-335fbb3d5c07",
      "name": "Filter Secret Scanning1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48544,
        33200
      ],
      "executeOnce": false,
      "alwaysOutputData": true,
      "notes": "Extracts required fields: secret_type_display_name, secret, html_url, path"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// Check if we have any items\nif (!items || items.length === 0) {\n  console.log('Filter Dependabot: No items to process');\n  return [];\n}\n\n// Filter out empty/invalid items\nconst validItems = items.filter(item => {\n  const alert = item.json;\n  return alert && \n         alert.security_advisory && \n         alert.security_advisory.summary &&\n         alert.html_url &&\n         !alert.message;\n});\n\nif (validItems.length === 0) {\n  console.log('Filter Dependabot: No valid dependabot alerts found');\n  return [];\n}\n\nconsole.log(`Filter Dependabot: Processing ${validItems.length} alerts`);\n\nreturn validItems.map(item => {\n  const alert = item.json;\n  \n  return {\n    json: {\n      scan_type: 'Dependabot',\n      title: alert.security_advisory.summary,\n      description: `**Summary:** ${alert.security_advisory.summary}\n**Description:** ${alert.security_advisory.description || 'N/A'}\n**Severity:** ${alert.security_advisory.severity || 'Unknown'}\n**CVE:** ${alert.security_advisory.cve_id || 'N/A'}\n**Package:** ${alert.security_vulnerability?.package?.name || 'N/A'}\n**Alert URL:** ${alert.html_url}`,\n      html_url: alert.html_url,\n      severity: alert.security_advisory.severity || 'unknown',\n      state: alert.state || 'open',\n      repository: extractRepo(alert.html_url)\n    }\n  };\n});\n\nfunction extractRepo(url) {\n  if (!url) return 'Unknown';\n  const match = url.match(/github\\.com\\/[^\\/]+\\/([^\\/]+)/);\n  return match ? match[1] : 'Unknown';\n}"
      },
      "id": "737291e5-454e-4701-867a-bd7692479a1d",
      "name": "Filter Dependabot1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48544,
        33008
      ],
      "notes": "Extracts required fields: security_advisory.summary, html_url, description"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// Check if we have any items\nif (!items || items.length === 0) {\n  console.log('Filter Code Scanning: No items to process');\n  return [];\n}\n\n// Filter out empty/invalid items\nconst validItems = items.filter(item => {\n  const alert = item.json;\n  return alert && \n         alert.rule && \n         (alert.rule.description || alert.rule.id) &&\n         alert.html_url &&\n         !alert.message;\n});\n\nif (validItems.length === 0) {\n  console.log('Filter Code Scanning: No valid code scanning alerts found');\n  return [];\n}\n\nconsole.log(`Filter Code Scanning: Processing ${validItems.length} alerts`);\n\nreturn validItems.map(item => {\n  const alert = item.json;\n  \n  return {\n    json: {\n      scan_type: 'Code Scanning',\n      title: alert.rule.description || alert.rule.id,\n      description: `**Rule:** ${alert.rule.description || alert.rule.id}\n**Full Description:** ${alert.rule.full_description || alert.rule.help || 'N/A'}\n**Severity:** ${alert.rule.severity || 'Unknown'}\n**Tool:** ${alert.tool?.name || 'N/A'}\n**Location:** ${alert.most_recent_instance?.location?.path || 'N/A'}\n**Alert URL:** ${alert.html_url}`,\n      html_url: alert.html_url,\n      severity: alert.rule.severity || 'unknown',\n      state: alert.state || 'open',\n      repository: extractRepo(alert.html_url)\n    }\n  };\n});\n\nfunction extractRepo(url) {\n  if (!url) return 'Unknown';\n  const match = url.match(/github\\.com\\/[^\\/]+\\/([^\\/]+)/);\n  return match ? match[1] : 'Unknown';\n}"
      },
      "id": "7417066d-11a8-49ee-86e3-89964c0323d1",
      "name": "Filter Code Scanning1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48544,
        32816
      ],
      "notes": "Extracts required fields: rule.description, html_url, rule.full_description"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        47680,
        32960
      ],
      "id": "b960d182-c7ad-458c-a863-989746f68746",
      "name": "Manual Trigger"
    }
  ],
  "pinData": {},
  "connections": {
    "Loop Over Items2": {
      "main": [
        [
          {
            "node": "Aggregate Results2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Results2": {
      "main": [
        [
          {
            "node": "Generate Report2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent3": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent3",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "create_new_pbi3": {
      "ai_tool": [
        [
          {
            "node": "AI Agent3",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "search_for_existing_pbi3": {
      "ai_tool": [
        [
          {
            "node": "AI Agent3",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "update_existing_pbi3": {
      "ai_tool": [
        [
          {
            "node": "AI Agent3",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Repo List3": {
      "main": [
        [
          {
            "node": "Split Repos3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine All Alerts3": {
      "main": [
        [
          {
            "node": "Aggregate All Alerts3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Code Scanning3": {
      "main": [
        [
          {
            "node": "Filter Code Scanning1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Dependabot3": {
      "main": [
        [
          {
            "node": "Filter Dependabot1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Secret Scanning3": {
      "main": [
        [
          {
            "node": "Filter Secret Scanning1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Repos3": {
      "main": [
        [
          {
            "node": "Get Code Scanning3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Dependabot3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Secret Scanning3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate All Alerts3": {
      "main": [
        [
          {
            "node": "Compress Alert Data3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get_pbi_details3": {
      "ai_tool": [
        [
          {
            "node": "AI Agent3",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Compress Alert Data3": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Adaptive Card3": {
      "main": [
        [
          {
            "node": "Post to Teams3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Report2": {
      "main": [
        [
          {
            "node": "Format Adaptive Card3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Secret Scanning1": {
      "main": [
        [
          {
            "node": "Combine All Alerts3",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Filter Dependabot1": {
      "main": [
        [
          {
            "node": "Combine All Alerts3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Filter Code Scanning1": {
      "main": [
        [
          {
            "node": "Combine All Alerts3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Repo List3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "0baf5fea-e876-43c0-8e68-b367ec2f209e",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "857ccbc685255d737a652c5892ef034718a3f0ab3053f36de5f8fed84a5c2ef2"
  },
  "id": "Wmik4DzlwZIxke1N",
  "tags": []
}